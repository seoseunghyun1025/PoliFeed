<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì „ ëª¨ì˜ ë©´ì ‘</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .chat-container { max-width: 800px; margin: 0 auto; }
        .chat-box { height: 550px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #ddd; padding: 20px; border-radius: 10px; }
        .message { margin-bottom: 15px; max-width: 85%; }
        .message.ai { margin-right: auto; }
        .message.user { margin-left: auto; text-align: right; }
        .bubble { padding: 12px 18px; border-radius: 15px; display: inline-block; text-align: left; line-height: 1.6; white-space: pre-wrap; }
        .ai .bubble { background-color: #e9ecef; color: #333; border-top-left-radius: 0; }
        .user .bubble { background-color: #0d6efd; color: white; border-top-right-radius: 0; }
        .feedback-box { background-color: #fff3cd; border: 1px solid #ffecb5; border-radius: 10px; padding: 15px; margin-top: 10px; font-size: 0.95rem; }
        textarea::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="/">PoliFeed</a>
        <div class="d-flex" th:if="${userName != null}">
            <span class="navbar-text text-white me-3">ë°˜ê°‘ìŠµë‹ˆë‹¤, <strong th:text="${userName}">User</strong>ë‹˜!</span>
            <a href="/mypage" class="btn btn-sm btn-outline-warning me-2">ğŸ“‚ ë³´ê´€í•¨</a>
            <a href="/logout" class="btn btn-sm btn-outline-light">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</nav>

<div class="container py-3 chat-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold mb-0">ğŸ™ï¸ AI ëª¨ì˜ ë©´ì ‘ì‹¤</h3>
        <a th:href="@{/mypage/{id}(id=${dto.id})}" class="btn btn-outline-secondary">ë‚˜ê°€ê¸° ğŸšª</a>
    </div>

    <div class="card mb-3 border-warning">
        <div class="card-body py-2 d-flex align-items-center bg-white rounded">
            <label class="fw-bold me-3 text-nowrap">ğŸ­ ë©´ì ‘ê´€ ì„¤ì •:</label>
            <select id="personaSelect" class="form-select form-select-sm border-warning fw-bold">
                <option value="strict" th:selected="${dto.persona == 'strict'}">ğŸ”¥ ê¹ê¹í•œ ëŒ€ê¸°ì—… ì¸ì‚¬íŒ€ì¥</option>
                <option value="friendly" th:selected="${dto.persona == 'friendly'}">ğŸ€ ì¹œì ˆí•œ ìŠ¤íƒ€íŠ¸ì—… CTO</option>
                <option value="consultant" th:selected="${dto.persona == 'consultant'}">ğŸ‘¨â€ğŸ« ì •ì„ ì·¨ì—… ì»¨ì„¤í„´íŠ¸</option>
            </select>
        </div>
    </div>

    <div id="chatBox" class="chat-box mb-3 shadow-sm bg-white">
    </div>

    <div class="input-group mb-3 align-items-end">
        <textarea id="userAnswer" class="form-control" rows="1"
                  placeholder="ì§ˆë¬¸ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..." disabled
                  style="resize: none; overflow-y: hidden; min-height: 38px; max-height: 150px;"></textarea>
        <button class="btn btn-primary" id="sendBtn" onclick="handleAction()" style="height: 100%;" disabled>ì „ì†¡ â¬†ï¸</button>
    </div>

    <div class="text-center">
        <button id="nextBtn" class="btn btn-lg btn-secondary w-100 fw-bold shadow-sm" onclick="showNextQuestion()" style="display: none;">
            ëŒ€í™” ê·¸ë§Œí•˜ê³  ë‹¤ìŒ ì§ˆë¬¸ ë°›ê¸° â¡ï¸
        </button>
    </div>

    <input type="hidden" id="resumeText" th:value="${dto.originalText}">
    <input type="hidden" id="jdText" th:value="${dto.jdText}">
</div>

<script>
    let questions = [];
    let currentQIndex = 0;

    // false: ë©´ì ‘ ë‹µë³€ ì¤‘ / true: ììœ  ëŒ€í™” ì¤‘
    let isChatMode = false;
    let lastFeedbackContext = "";

    // [ìë™ ì‹œì‘] í˜ì´ì§€ ë¡œë“œë˜ìë§ˆì ì‹¤í–‰
    document.addEventListener("DOMContentLoaded", function() {
        startInterview();
    });

    // ì—”í„°/ì „ì†¡ ë¡œì§ ë¶„ê¸°
    function handleAction() {
        if (!isChatMode) submitAnswer(); // ë©´ì ‘ ë‹µë³€ ì œì¶œ
        else submitChat();               // ììœ  ì§ˆë¬¸ (í‹°í‚¤íƒ€ì¹´)
    }

    // 1. ë©´ì ‘ ì‹œì‘ (ìë™)
    async function startInterview() {
        addMessage('ai', `ì•ˆë…•í•˜ì„¸ìš”! ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ğŸ‘¨â€ğŸ’¼<br>ì§€ì›ìë‹˜ì˜ ì„œë¥˜(<strong>[[${dto.topic}]]</strong>)ë¥¼ ê²€í† í•˜ê³  ì§ˆë¬¸ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...`);

        const resumeText = document.getElementById('resumeText').value;
        const jdText = document.getElementById('jdText').value;
        const persona = document.getElementById('personaSelect').value;

        try {
            const response = await fetch('/api/interview/init', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ resumeText, jdText, persona })
            });
            questions = await response.json();
            showNextQuestion(); // ë°”ë¡œ ì²« ì§ˆë¬¸ ë˜ì§€ê¸°
        } catch (e) {
            alert("ì˜¤ë¥˜ ë°œìƒ! ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
    }

    // 2. ì§ˆë¬¸ í‘œì‹œ
    function showNextQuestion() {
        if (currentQIndex >= questions.length) {
            addMessage('ai', "ë©´ì ‘ì´ ëª¨ë‘ ëë‚¬ìŠµë‹ˆë‹¤. ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤! ğŸ‰");
            document.getElementById('userAnswer').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('nextBtn').style.display = 'none';
            return;
        }

        addMessage('ai', `<strong>Q${currentQIndex + 1}.</strong> ${questions[currentQIndex]}`);
        lastFeedbackContext = questions[currentQIndex];

        // ìƒíƒœ: ë‹µë³€ ëª¨ë“œ
        isChatMode = false;
        document.getElementById('nextBtn').style.display = 'none';

        // ì…ë ¥ì°½ í™œì„±í™”
        const input = document.getElementById('userAnswer');
        input.disabled = false;
        input.placeholder = "ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...";
        input.focus();
        document.getElementById('sendBtn').disabled = false;
    }

    // 3. ë©´ì ‘ ë‹µë³€ ì œì¶œ -> í”¼ë“œë°± ë°›ê¸°
    async function submitAnswer() {
        const input = document.getElementById('userAnswer');
        const answer = input.value;
        if (!answer.trim()) return;

        addMessage('user', answer);
        input.value = '';
        input.disabled = true;
        document.getElementById('sendBtn').disabled = true;

        addMessage('ai', "ë‹µë³€ ë¶„ì„ ì¤‘... ğŸ§");

        try {
            const response = await fetch('/api/interview/feedback', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ question: questions[currentQIndex], answer: answer })
            });
            const feedback = await response.text();

            // í”¼ë“œë°± í‘œì‹œ
            const chatBox = document.getElementById('chatBox');
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'feedback-box mb-3 shadow-sm';
            feedbackDiv.innerHTML = marked.parse(feedback);
            chatBox.appendChild(feedbackDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            // [ìƒíƒœ ì „í™˜] ì´ì œ ììœ  ëŒ€í™” ëª¨ë“œ
            isChatMode = true;
            lastFeedbackContext = feedback;

            // ì…ë ¥ì°½ ë‹¤ì‹œ í™œì„±í™” (ê¶ê¸ˆí•œ ê±° ë¬¼ì–´ë³´ë¼ê³ )
            input.disabled = false;
            input.placeholder = "í”¼ë“œë°±ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”. (ë„˜ì–´ê°€ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ í´ë¦­)";
            input.focus();
            document.getElementById('sendBtn').disabled = false;

            // 'ë‹¤ìŒ ì§ˆë¬¸' ë²„íŠ¼ í‘œì‹œ
            document.getElementById('nextBtn').style.display = 'block';
            currentQIndex++;

        } catch (e) { alert("í‰ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }
    }

    // 4. ììœ  ëŒ€í™” (í‹°í‚¤íƒ€ì¹´)
    async function submitChat() {
        const input = document.getElementById('userAnswer');
        const message = input.value;
        if (!message.trim()) return;

        addMessage('user', message);
        input.value = '';
        input.disabled = true;

        const persona = document.getElementById('personaSelect').value;

        try {
            // ì±„íŒ… API í˜¸ì¶œ (Controllerì— ì´ APIê°€ ìˆì–´ì•¼ í•¨)
            const response = await fetch('/api/interview/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    context: lastFeedbackContext,
                    message: message,
                    persona: persona
                })
            });
            const reply = await response.text();

            addMessage('ai', reply);
            lastFeedbackContext = reply; // ë¬¸ë§¥ ì—…ë°ì´íŠ¸

            input.disabled = false;
            input.focus();
        } catch (e) {
            // ë§Œì•½ ì±„íŒ… APIê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì•Œë¦¼
            alert("ì±„íŒ… ê¸°ëŠ¥ APIê°€ ì„œë²„ì— ì—†ìŠµë‹ˆë‹¤. MainControllerì— /api/interview/chatì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
            input.disabled = false;
        }
    }

    function addMessage(sender, html) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.innerHTML = `<div class="bubble">${html}</div>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    const inputField = document.getElementById('userAnswer');
    inputField.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    inputField.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleAction();
        }
    });
</script>

</body>
</html>