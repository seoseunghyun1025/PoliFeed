<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì „ ëª¨ì˜ ë©´ì ‘</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .chat-container { max-width: 800px; margin: 0 auto; }
        .chat-box { height: 550px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #ddd; padding: 20px; border-radius: 10px; }
        .message { margin-bottom: 15px; max-width: 85%; }
        .message.ai { margin-right: auto; }
        .message.user { margin-left: auto; text-align: right; }
        .bubble { padding: 12px 18px; border-radius: 15px; display: inline-block; text-align: left; line-height: 1.6; white-space: pre-wrap; }
        .ai .bubble { background-color: #e9ecef; color: #333; border-top-left-radius: 0; }
        .user .bubble { background-color: #0d6efd; color: white; border-top-right-radius: 0; }
        .feedback-box { background-color: #fff3cd; border: 1px solid #ffecb5; border-radius: 10px; padding: 15px; margin-top: 10px; font-size: 0.95rem; }
        textarea::-webkit-scrollbar { display: none; }

        /* ë§ˆì´í¬ ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜ (ë…¹ìŒ ì¤‘ì¼ ë•Œ ê¹œë¹¡ì„) */
        .recording {
            animation: pulse 1.5s infinite;
            background-color: #dc3545 !important; /* ë¹¨ê°„ìƒ‰ */
            color: white !important;
            border-color: #dc3545 !important;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="/">PoliFeed</a>
        <div class="d-flex" th:if="${userName != null}">
            <span class="navbar-text text-white me-3">ë°˜ê°‘ìŠµë‹ˆë‹¤, <strong th:text="${userName}">User</strong>ë‹˜!</span>
            <a href="/mypage" class="btn btn-sm btn-outline-warning me-2">ğŸ“‚ ë³´ê´€í•¨</a>
            <a href="/logout" class="btn btn-sm btn-outline-light">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</nav>

<div class="container py-3 chat-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold mb-0">ğŸ™ï¸ AI ëª¨ì˜ ë©´ì ‘ì‹¤</h3>
        <div class="d-flex align-items-center gap-2">
            <button id="ttsToggleBtn" class="btn btn-outline-primary btn-sm" onclick="toggleTTS()">
                ğŸ”Š ë“£ê¸°: ON
            </button>
            <a th:href="@{/mypage/{id}(id=${dto.id})}" class="btn btn-outline-secondary btn-sm">ë‚˜ê°€ê¸° ğŸšª</a>
        </div>
    </div>

    <div class="card mb-3 border-warning">
        <div class="card-body py-2 d-flex align-items-center bg-white rounded">
            <label class="fw-bold me-3 text-nowrap">ğŸ­ ë©´ì ‘ê´€ ì„¤ì •:</label>
            <select id="personaSelect" class="form-select form-select-sm border-warning fw-bold">
                <option value="strict" th:selected="${dto.persona == 'strict'}">ğŸ”¥ ê¹ê¹í•œ ëŒ€ê¸°ì—… ì¸ì‚¬íŒ€ì¥</option>
                <option value="friendly" th:selected="${dto.persona == 'friendly'}">ğŸ€ ì¹œì ˆí•œ ìŠ¤íƒ€íŠ¸ì—… CTO</option>
                <option value="consultant" th:selected="${dto.persona == 'consultant'}">ğŸ‘¨â€ğŸ« ì •ì„ ì·¨ì—… ì»¨ì„¤í„´íŠ¸</option>
            </select>
        </div>
    </div>

    <div id="chatBox" class="chat-box mb-3 shadow-sm bg-white"></div>

    <div class="input-group mb-3 align-items-end">
        <button class="btn btn-outline-secondary" type="button" id="micBtn" onclick="toggleRecording()" style="height: 100%; border-right: 0;">
            ğŸ¤
        </button>

        <textarea id="userAnswer" class="form-control" rows="1"
                  placeholder="ì§ˆë¬¸ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..." disabled
                  style="resize: none; overflow-y: hidden; min-height: 38px; max-height: 150px; border-left: 0;"></textarea>

        <button class="btn btn-primary" id="sendBtn" onclick="handleAction()" style="height: 100%;" disabled>ì „ì†¡ â¬†ï¸</button>
    </div>

    <div class="text-center">
        <button id="nextBtn" class="btn btn-lg btn-secondary w-100 fw-bold shadow-sm" onclick="goNextQuestion()" style="display: none;">
            ëŒ€í™” ê·¸ë§Œí•˜ê³  ë‹¤ìŒ ì§ˆë¬¸ ë°›ê¸° â¡ï¸
        </button>
    </div>

    <input type="hidden" id="resumeText" th:value="${dto.originalText}">
    <input type="hidden" id="jdText" th:value="${dto.jdText}">
</div>

<script>
    let questions = [];
    let currentQIndex = 0;
    let isChatMode = false;
    let lastFeedbackContext = "";

    // ìŒì„± ê´€ë ¨ ë³€ìˆ˜
    let ttsEnabled = true;
    let recognition = null;
    let isRecording = false; // ë§ˆì´í¬ ìƒíƒœ ì²´í¬ìš©

    document.addEventListener("DOMContentLoaded", function() {
        initSpeechRecognition();
        startInterview();
    });

    // 1. ìŒì„± ì¸ì‹ ì´ˆê¸°í™”
    function initSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert("âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\ní¬ë¡¬(Chrome) ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
            document.getElementById('micBtn').style.display = 'none';
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'ko-KR';
        recognition.continuous = false;
        recognition.interimResults = false;

        // [ì´ë²¤íŠ¸] ë§ˆì´í¬ ì¼œì§
        recognition.onstart = function() {
            console.log("ğŸ¤ ë§ˆì´í¬ ì¼œì§");
            isRecording = true;
            updateMicUI(true);
        };

        // [ì´ë²¤íŠ¸] ë§ˆì´í¬ êº¼ì§
        recognition.onend = function() {
            console.log("ğŸ›‘ ë§ˆì´í¬ êº¼ì§");
            isRecording = false;
            updateMicUI(false);
        };

        // [ì´ë²¤íŠ¸] ê²°ê³¼ ìˆ˜ì‹ 
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            console.log("âœ… ì¸ì‹ ê²°ê³¼:", transcript);

            const input = document.getElementById('userAnswer');
            if (input.value.trim().length > 0) {
                input.value += " " + transcript;
            } else {
                input.value = transcript;
            }

            // ë†’ì´ ì¡°ì ˆ
            input.style.height = 'auto';
            input.style.height = (input.scrollHeight) + 'px';
        };

        // [ì´ë²¤íŠ¸] ì—ëŸ¬ ë°œìƒ
        recognition.onerror = function(event) {
            console.error("ğŸš¨ ìŒì„± ì¸ì‹ ì—ëŸ¬:", event.error);

            // "aborted"ë‚˜ "no-speech"ëŠ” í”í•œ ì—ëŸ¬ë¼ ë¬´ì‹œí•˜ê±°ë‚˜ ì¡°ìš©íˆ ì²˜ë¦¬
            if (event.error === 'no-speech') {
                // alert("ì†Œë¦¬ê°€ ë“¤ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤."); // ë„ˆë¬´ ìì£¼ ëœ¨ë©´ ë¶ˆí¸í•˜ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬
            } else if (event.error === 'not-allowed') {
                alert("ğŸ”’ ë§ˆì´í¬ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
            }

            // ì—ëŸ¬ ë‚˜ë©´ ê°•ì œë¡œ ë„ê¸° ìƒíƒœë¡œ ì „í™˜
            isRecording = false;
            updateMicUI(false);
        };
    }

    // 2. ë²„íŠ¼ í´ë¦­ ì‹œ (í† ê¸€)
    function toggleRecording() {
        if (!recognition) return;

        if (isRecording) {
            recognition.stop();
        } else {
            // â˜… í•µì‹¬ ìˆ˜ì •: try-catchë¡œ ê°ì‹¸ì„œ 'ì´ë¯¸ ì¼œì§' ì—ëŸ¬ ë¬´ì‹œ
            try {
                recognition.start();
            } catch (e) {
                console.warn("ë§ˆì´í¬ ì‹œì‘ ì‹¤íŒ¨ (ì´ë¯¸ ì¼œì ¸ìˆì„ ìˆ˜ ìˆìŒ):", e);
            }
        }
    }

    // 3. UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë²„íŠ¼ ë¹¨ê°„ìƒ‰ ì²˜ë¦¬)
    function updateMicUI(on) {
        const micBtn = document.getElementById('micBtn');
        const input = document.getElementById('userAnswer');

        if (on) {
            micBtn.classList.add('recording');
            input.placeholder = "ë“£ê³  ìˆìŠµë‹ˆë‹¤... ğŸ‘‚";
        } else {
            micBtn.classList.remove('recording');
            input.placeholder = isChatMode ? "ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”." : "ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...";
        }
    }

    // --- TTS (ë§í•˜ê¸°) ---
    function speakText(text) {
        if (!ttsEnabled || !('speechSynthesis' in window)) return;
        const cleanText = text.replace(/<[^>]*>?/gm, '');
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.lang = 'ko-KR';
        window.speechSynthesis.speak(utterance);
    }

    function toggleTTS() {
        ttsEnabled = !ttsEnabled;
        const btn = document.getElementById('ttsToggleBtn');
        if (ttsEnabled) {
            btn.innerHTML = "ğŸ”Š ë“£ê¸°: ON";
            btn.classList.replace('btn-outline-secondary', 'btn-outline-primary');
        } else {
            btn.innerHTML = "ğŸ”‡ ë“£ê¸°: OFF";
            btn.classList.replace('btn-outline-primary', 'btn-outline-secondary');
            window.speechSynthesis.cancel();
        }
    }

    // --- ë©´ì ‘ ë¡œì§ ---
    function handleAction() {
        if (!isChatMode) submitAnswer();
        else submitChat();
    }

    async function startInterview() {
        addMessage('ai', `ì•ˆë…•í•˜ì„¸ìš”! ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ğŸ‘¨â€ğŸ’¼<br>ì§€ì›ìë‹˜ì˜ ì„œë¥˜(<strong>[[${dto.topic}]]</strong>)ë¥¼ ê²€í† í•˜ê³  ì§ˆë¬¸ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...`);
        speakText("ì•ˆë…•í•˜ì„¸ìš” ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ì„œë¥˜ë¥¼ ê²€í† í•˜ê³  ì§ˆë¬¸ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");

        const resumeText = document.getElementById('resumeText').value;
        const jdText = document.getElementById('jdText').value;
        const persona = document.getElementById('personaSelect').value;

        try {
            const response = await fetch('/api/interview/init', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ resumeText, jdText, persona })
            });
            questions = await response.json();

            if (!questions || questions.length === 0) {
                questions = ["ìê¸°ì†Œê°œë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤.", "ì„±ê²©ì˜ ì¥ë‹¨ì ì€?", "ì§€ì› ë™ê¸°ëŠ” ë¬´ì—‡ì¸ê°€ìš”?"];
            }
            showCurrentQuestion();
        } catch (e) {
            console.error(e);
            alert("ì„œë²„ ì—°ê²° ì˜¤ë¥˜");
        }
    }

    function showCurrentQuestion() {
        if (currentQIndex >= questions.length) {
            addMessage('ai', "ë©´ì ‘ì´ ëª¨ë‘ ëë‚¬ìŠµë‹ˆë‹¤. ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤! ğŸ‰");
            speakText("ë©´ì ‘ì´ ëª¨ë‘ ëë‚¬ìŠµë‹ˆë‹¤. ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤.");
            document.getElementById('userAnswer').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('micBtn').disabled = true;
            document.getElementById('nextBtn').style.display = 'none';
            return;
        }

        const question = questions[currentQIndex];
        addMessage('ai', `<strong>Q${currentQIndex + 1}.</strong> ${question}`);
        speakText(question);

        lastFeedbackContext = question;
        isChatMode = false;
        document.getElementById('nextBtn').style.display = 'none';

        const input = document.getElementById('userAnswer');
        input.disabled = false;
        input.placeholder = "ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...";
        input.focus();
        document.getElementById('sendBtn').disabled = false;
    }

    function goNextQuestion() {
        currentQIndex++;
        showCurrentQuestion();
    }

    async function submitAnswer() {
        const input = document.getElementById('userAnswer');
        const answer = input.value;
        if (!answer.trim()) return;

        addMessage('user', answer);
        input.value = '';
        input.disabled = true;
        document.getElementById('sendBtn').disabled = true;
        window.speechSynthesis.cancel();

        addMessage('ai', "ë‹µë³€ ë¶„ì„ ì¤‘... ğŸ§");

        try {
            const response = await fetch('/api/interview/feedback', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ question: questions[currentQIndex], answer: answer })
            });
            const feedback = await response.text();

            const chatBox = document.getElementById('chatBox');
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'feedback-box mb-3 shadow-sm';
            feedbackDiv.innerHTML = marked.parse(feedback);
            chatBox.appendChild(feedbackDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            speakText("ë‹µë³€ì— ëŒ€í•œ í”¼ë“œë°±ì…ë‹ˆë‹¤.");

            isChatMode = true;
            lastFeedbackContext = feedback;

            input.disabled = false;
            input.placeholder = "ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”.";
            input.focus();
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('nextBtn').style.display = 'block';

        } catch (e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }

    async function submitChat() {
        const input = document.getElementById('userAnswer');
        const message = input.value;
        if (!message.trim()) return;

        addMessage('user', message);
        input.value = '';
        window.speechSynthesis.cancel();

        const persona = document.getElementById('personaSelect').value;

        try {
            const response = await fetch('/api/interview/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ context: lastFeedbackContext, message: message, persona: persona })
            });
            const reply = await response.text();

            addMessage('ai', reply);
            speakText(reply);
            lastFeedbackContext = reply;
        } catch (e) { alert("ëŒ€í™” ì˜¤ë¥˜"); }
    }

    function addMessage(sender, html) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.innerHTML = `<div class="bubble">${html}</div>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    const inputField = document.getElementById('userAnswer');
    inputField.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    inputField.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleAction();
        }
    });
</script>
</body>
</html>